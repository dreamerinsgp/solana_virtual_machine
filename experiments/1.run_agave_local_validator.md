# Building and Running Agave Local Validator

This guide will help you build and run a local Solana validator using the Agave codebase.

## Prerequisites

### 1. Install System Dependencies

On Ubuntu/Debian:
```bash
sudo apt-get update
sudo apt-get install libssl-dev libudev-dev pkg-config zlib1g-dev llvm clang cmake make libprotobuf-dev protobuf-compiler libclang-dev
```

### 2. Install Rust

The project uses a specific Rust version defined in `rust-toolchain.toml`. The `./cargo` script will automatically use the correct version.

```bash
curl https://sh.rustup.rs -sSf | sh
source $HOME/.cargo/env
rustup component add rustfmt
```

## Building the Validator

### Option 1: Build All Binaries (Recommended for first time)

```bash
cd /home/ubuntu/vm/agave_v1
./cargo build --all
```

This builds:
- `agave-validator` - The main validator binary
- `solana-test-validator` - Simplified test validator
- `solana-keygen`, `solana-genesis`, `solana-faucet` - Supporting tools

**Note:** This builds a debug version. For production/testnet use, see the release build instructions below.

### Option 2: Build Release Version (For Production/Testnet)

```bash
cd /home/ubuntu/vm/agave_v1
./cargo build --release --all
export CARGO_BUILD_PROFILE=release
```

### Option 3: Build Only Test Validator (Quickest for local testing)

```bash
cd /home/ubuntu/vm/agave_v1
./cargo build --bin solana-test-validator
```

## Running the Validator

### Method 1: Using `solana-test-validator` (Simplest)

The `solana-test-validator` is the easiest way to run a local validator for development:

```bash
cd /home/ubuntu/vm/agave_v1

# Build if not already built
./cargo build --bin solana-test-validator

# Run the test validator
./target/debug/solana-test-validator
```

**Default Configuration:**
- RPC URL: `http://127.0.0.1:8899`
- Gossip Address: `127.0.0.1:1024`
- TPU Address: `127.0.0.1:1027`
- Ledger location: `test-ledger/`

**Useful Options:**
```bash
# View all options
./target/debug/solana-test-validator --help

# Run with custom RPC port
./target/debug/solana-test-validator --rpc-port 8899

# Run with custom ledger directory
./target/debug/solana-test-validator --ledger /path/to/ledger

# Limit ledger size
./target/debug/solana-test-validator --limit-ledger-size 50000000
```

### Method 2: Using `scripts/run.sh` (Full Validator Setup)

This script sets up a complete local cluster with genesis, faucet, and validator:

```bash
cd /home/ubuntu/vm/agave_v1

# First, ensure binaries are built
./cargo build --all

# Run the script (it will set up everything)
./scripts/run.sh
```

This script will:
1. Generate validator keypairs if they don't exist
2. Download core BPF programs and SPL programs
3. Generate genesis
4. Start a faucet
5. Start the validator

**Configuration:**
- Validator identity: `config/run.sh/validator-identity.json`
- Vote account: `config/run.sh/validator-vote-account.json`
- Ledger: `config/ledger/`
- RPC: `http://127.0.0.1:8899`
- Faucet: `127.0.0.1:9900`

### Method 3: Manual Validator Setup

If you want more control, you can set up manually:

```bash
cd /home/ubuntu/vm/agave_v1

# 1. Build binaries
./cargo build --all

# 2. Add binaries to PATH
export PATH=$PWD/target/debug:$PATH

# 3. Generate keypairs (if needed)
solana-keygen new --no-passphrase -o validator-identity.json
solana-keygen new --no-passphrase -o validator-vote-account.json
solana-keygen new --no-passphrase -o validator-stake-account.json

# 4. Download BPF programs
./fetch-core-bpf.sh
./fetch-spl.sh

# 5. Generate genesis
solana-genesis \
  --hashes-per-tick sleep \
  --faucet-lamports 500000000000000000 \
  --bootstrap-validator \
    validator-identity.json \
    validator-vote-account.json \
    validator-stake-account.json \
  --ledger ./ledger

# 6. Start faucet (in separate terminal)
solana-faucet &

# 7. Start validator
agave-validator \
  --identity validator-identity.json \
  --vote-account validator-vote-account.json \
  --ledger ./ledger \
  --gossip-port 8001 \
  --full-rpc-api \
  --rpc-port 8899 \
  --rpc-faucet-address 127.0.0.1:9900 \
  --log -
```

## Verifying the Validator is Running

### Check RPC Endpoint

```bash
# Get cluster info
curl http://127.0.0.1:8899 -X POST -H "Content-Type: application/json" -d '{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "getClusterInfo"
}'

# Get slot
curl http://127.0.0.1:8899 -X POST -H "Content-Type: application/json" -d '{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "getSlot"
}'
```

### Check Validator Logs

The validator will print status information:
```
Ledger location: test-ledger
Log: test-ledger/validator.log
Identity: EPhgPANa5Rh2wa4V2jxt7YbtWa3Uyw4sTeZ13cQjDDB8
Genesis Hash: 4754oPEMhAKy14CZc8GzQUP93CB4ouELyaTs4P8ittYn
Version: 1.6.7
Shred Version: 13286
Gossip Address: 127.0.0.1:1024
TPU Address: 127.0.0.1:1027
JSON RPC URL: http://127.0.0.1:8899
⠈ 00:36:02 | Processed Slot: 5142 | Confirmed Slot: 5142 | Finalized Slot: 5110 | Snapshot Slot: 5100 | Transactions: 5142 | ◎499.974295000
```

## Troubleshooting

### Build Issues

**Error: "linker `cc` not found"**
```bash
sudo apt-get install build-essential
```

**Error: "could not find native static library `c`"**
```bash
sudo apt-get install libc6-dev
```

**Error: "protoc not found"**
```bash
sudo apt-get install protobuf-compiler
```

### Runtime Issues

**Port already in use:**
- Change the port: `--rpc-port 8900` (or another available port)
- Or kill the process using the port: `lsof -ti:8899 | xargs kill`

**Out of disk space:**
- Use `--limit-ledger-size` to limit ledger growth
- Or clean up old ledger directories

**Validator won't start:**
- Check logs in the ledger directory (e.g., `test-ledger/validator.log`)
- Ensure all required binaries are built
- Verify keypairs are valid

## Next Steps

Once your validator is running, you can:

1. **Send transactions** using the Solana CLI or SDK
2. **Deploy programs** using `solana program deploy`
3. **Interact with accounts** using RPC calls
4. **Monitor performance** using the status output

## Useful Commands

```bash
# Check validator version
./target/debug/agave-validator --version

# Check all available options
./target/debug/agave-validator --help

# Check test validator options
./target/debug/solana-test-validator --help

# View logs in real-time (if using test-ledger)
tail -f test-ledger/validator.log
```
