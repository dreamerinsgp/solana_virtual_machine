reference:
https://www.helius.dev/blog/solana-virtual-machine#what-makes-the-svm-special-upfront-account-declarations

The Banking Stage is where transaction execution happens within a validatorâ€™s Transaction Processing Unit (TPU). It receives verified transactions from the SigVerify stage, buffers them, and schedules them for parallel execution using conflict detection on account locks


The defining architectural decision of the SVM is that all transactions must explicitly declare which accounts they will read from and write to before execution begins. This simple requirement, baked into the transaction format itself, unlocks two transformative capabilities that set Solana apart: parallel execution and localized fee markets.


Q1: all Solana transactions explicitly declare which accounts they will read from and write to before execution begins. why it matters to parallel executing ?

Declaring which accounts a transaction will read and write to allows for the runtime to analyze account dependencies to detect conflicts and schedule non-conflicting transactions:

Rules: 
1. Transactions that touch completely different accounts can run in parallel with zero coordination overhead.

2. Transactions that only read from the same accounts can also run in parallel since reads do not conflict.

3. Transactions that attempt to write to the same accounts run sequentially to prevent race conditions and ensure state consistency. 


Q2: Where can I find the code related to it ?

**Code Locations:**

1. **Transaction Account Declaration** (where transactions declare accounts):
   - `agave_v1/svm-transaction/src/svm_message.rs` - `SVMMessage` trait defines `account_keys()` and `is_writable(index)` methods
   - `agave_v1/core/src/banking_stage/read_write_account_set.rs:14-26` - Uses `message.account_keys()` and `message.is_writable(index)` to check locks

2. **Conflict Detection Logic**:
   - `agave_v1/core/src/banking_stage/read_write_account_set.rs` - `ReadWriteAccountSet` struct implements conflict detection:
     - `check_locks()` (lines 14-26) - Checks if accounts can be locked
     - `can_read()` (lines 51-53) - Allows read if account not write-locked
     - `can_write()` (lines 55-58) - Allows write only if account not read-locked or write-locked
   - Rules implemented:
     - Read conflicts: `can_read()` returns false if account is write-locked
     - Write conflicts: `can_write()` returns false if account is read-locked OR write-locked
     - Multiple reads allowed: Multiple read locks on same account are permitted

3. **Transaction Scheduling** (Banking Stage scheduler):
   - `agave_v1/core/src/banking_stage/transaction_scheduler/prio_graph_scheduler.rs:382-438` - `try_schedule_transaction()` function:
     - Lines 402-410: Extracts write and read account locks from transaction
     - Lines 412-427: Attempts to lock accounts using `account_locks.try_lock_accounts()`
     - Returns `UnschedulableConflicts` error if conflicts detected
   - `agave_v1/core/src/banking_stage/transaction_scheduler/scheduler_controller.rs:214-223` - Main scheduling entry point

4. **Account Locks Implementation**:
   - `agave_v1/accounts-db/src/account_locks.rs` - `AccountLocks` struct:
     - `try_lock_accounts()` (lines 24-32) - Locks accounts for a transaction
     - `can_lock_accounts()` (lines 73-88) - Checks if accounts can be locked
     - `can_write_lock()` and `can_read_lock()` - Per-account lock checking
   - `agave_v1/accounts-db/src/accounts.rs:497-528` - `lock_accounts()` method that validates and locks accounts for batches

5. **Banking Stage Consumer** (execution pipeline):
   - `agave_v1/core/src/banking_stage/consumer.rs` - Main consumer that processes transaction batches
   - `agave_v1/core/src/banking_stage/consume_worker.rs` - Worker threads that execute transactions in parallel

6. **Thread-Aware Account Locks** (for parallel execution):
   - `agave_v1/core/src/banking_stage/transaction_scheduler/scheduler_common.rs:176` - `ThreadAwareAccountLocks` manages locks per thread
   - Allows different threads to hold locks on different accounts simultaneously

**Key Files Summary:**
- **Conflict Detection**: `agave_v1/core/src/banking_stage/read_write_account_set.rs`
- **Scheduling**: `agave_v1/core/src/banking_stage/transaction_scheduler/prio_graph_scheduler.rs`
- **Account Locks**: `agave_v1/accounts-db/src/account_locks.rs`
- **Transaction Format**: `agave_v1/svm-transaction/src/svm_message.rs`